<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Frost Predictions – per Sensor</title>
<style>
:root{color-scheme:light dark}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;margin:2rem;line-height:1.45}
h1{margin:0 0 .25rem}
.muted{color:#666;margin:0 0 1rem}
.controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:flex-end;margin:.75rem 0 0}
label{display:flex;flex-direction:column;font-size:.9rem}
input,button,select{padding:.45rem .55rem;border:1px solid #d1d5db;border-radius:.375rem;background:#fff}
button{cursor:pointer;background:#f3f4f6}
.badge{display:inline-block;padding:.15rem .45rem;border-radius:999px;font-size:.8rem;font-weight:600}
.ok{background:#e6f7ef;color:#065f46;border:1px solid #a7f3d0}
.warn{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
table{border-collapse:collapse;width:100%;margin-top:1rem}
th,td{border:1px solid #e5e7eb;padding:.5rem;text-align:left} th{background:#f9fafb}
#msg{margin:.5rem 0 0;color:#b91c1c}
#debug{margin-top:.5rem;font:12px/1.4 ui-monospace,monospace;color:#6b7280;white-space:pre-wrap}
a.btn{display:inline-block;text-decoration:none}
@media (prefers-color-scheme: dark){
  th,td{border-color:#374151} th{background:#111827}
  input,button,select{border-color:#4b5563;background:#1f2937;color:#e5e7eb}
}
</style>
</head>
<body>
  <h1>Frost predictions</h1>
  <p class="muted">Shows the latest frost risk per sensor over a selected period. Uses the ONNX predictor service.</p>

  <div class="controls">
    <a href="./" class="btn"><button type="button">← Back to Index</button></a>
  </div>

  <form id="auth" class="controls">
    <label>Username
      <input id="u" type="text" placeholder="admin" autocomplete="username" required>
    </label>
    <label>Password
      <input id="p" type="password" placeholder="••••••••" autocomplete="current-password" required>
    </label>
    <button id="signin" type="submit">Sign in</button>
    <button id="signout" type="button" style="display:none">Sign out</button>
    <span id="msg"></span>
  </form>

  <form id="filters" class="controls">
    <label>From (UTC)
      <input id="from" type="datetime-local" step="1" required>
    </label>
    <label>To (UTC)
      <input id="to" type="datetime-local" step="1" required>
    </label>
    <label>Preset
      <select id="preset">
        <option value="24h">Last 24 hours</option>
        <option value="7d">Last 7 days</option>
        <option value="30d">Last 30 days</option>
        <option value="custom">Custom</option>
      </select>
    </label>
    <button type="submit">Load predictions</button>
  </form>

  <table id="t">
    <thead>
      <tr>
        <th>Sensor</th>
        <th>Prediction time (UTC)</th>
        <th>Probability</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="4">Please sign in and load data…</td></tr></tbody>
  </table>

  <pre id="debug"></pre>

<script>
/* ---------- Small helpers ---------- */
const $ = (id)=>document.getElementById(id);
const qs = (sel)=>document.querySelector(sel);
const fmtPct = (x)=> (x==null || !isFinite(x)) ? '' : (Number(x)*100).toFixed(1) + '%';
function b64utf8(str){ return btoa(String.fromCharCode(...new TextEncoder().encode(str))); }
function toUtcLocalInputValue(d){ // Date -> "YYYY-MM-DDTHH:MM:SS"
  const pad = (n)=> String(n).padStart(2,'0');
  return d.getUTCFullYear() + '-' + pad(d.getUTCMonth()+1) + '-' + pad(d.getUTCDate()) +
         'T' + pad(d.getUTCHours()) + ':' + pad(d.getUTCMinutes()) + ':' + pad(d.getUTCSeconds());
}
function isoFromLocalInput(v){ // "YYYY-MM-DDTHH:MM:SS" (assumed UTC) -> ISO "Z"
  if (!v) return null;
  // Interpret as UTC, not local
  return v.endsWith('Z') ? v : (v + 'Z');
}
function getParam(name){
  const u = new URL(window.location.href);
  return u.searchParams.get(name);
}

/* ---------- Config for predictor endpoint ---------- */
// Default to same-origin '/predict'. Override with ?predictBase=URL
//const PREDICT_URL = getParam('predictBase') || '/predict';
const PREDICT_URL = '/predict';

/* ---------- Auth state ---------- */
let AUTH = null;
function setSignedInUI(signedIn){
  $('signout').style.display = signedIn ? '' : 'none';
}

/* ---------- Default time range ---------- */
function setPreset(preset){
  const now = new Date();
  const to = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds()));
  let from = new Date(to);
  if (preset === '24h') from = new Date(to.getTime() - 24*3600*1000);
  if (preset === '7d')  from = new Date(to.getTime() - 7*24*3600*1000);
  if (preset === '30d') from = new Date(to.getTime() - 30*24*3600*1000);
  $('from').value = toUtcLocalInputValue(from);
  $('to').value   = toUtcLocalInputValue(to);
}
$('preset').addEventListener('change', (e)=>{
  if (e.target.value !== 'custom') setPreset(e.target.value);
});

/* ---------- Fetch & render ---------- */
async function loadPredictions(){
  const tb = qs('#t tbody');
  const dbg = $('debug');
  const msg = $('msg');

  if (!AUTH) { tb.innerHTML = '<tr><td colspan="4">Please sign in…</td></tr>'; return; }

  const fromISO = isoFromLocalInput($('from').value);
  const toISO   = isoFromLocalInput($('to').value);
  const url = new URL(PREDICT_URL, window.location.origin);
  if (fromISO) url.searchParams.set('from', fromISO);
  if (toISO)   url.searchParams.set('to', toISO);

  dbg.textContent = 'GET ' + url.toString().replace(window.location.origin, '') + '\nAuthorization: Basic <hidden>';

  try{
    const r = await fetch(url.toString(), {
      headers: { Authorization: AUTH },
      cache: 'no-store'
    });
    const text = await r.clone().text().catch(()=> '');
    if (r.status === 401) { setSignedInUI(false); msg.textContent = 'Authentication failed.'; tb.innerHTML = '<tr><td colspan="4">Auth failed</td></tr>'; return; }
    if (!r.ok) { setSignedInUI(true); msg.textContent = 'Error ' + r.status + (text?(' '+text):''); return; }

    setSignedInUI(true); msg.textContent = '';
    const j = JSON.parse(text);

    const rows = (j.points || []);
    // group or just show one per sensor (already latest per sensor from server)
    // Sort sensors A→Z
    rows.sort((a,b)=> String(a.sensorName).localeCompare(String(b.sensorName)));

    tb.innerHTML = '';
    rows.forEach(p=>{
      const prob = Number(p.score);
      const frost = prob >= 0.5;
      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td>'+ (p.sensorName ?? '') +'</td>'+
        '<td>'+ (p.time ?? '') +'</td>'+
        '<td>'+ (isFinite(prob)? fmtPct(prob): '') +'</td>'+
        '<td>'+ (frost
                 ? '<span class="badge warn">FROST</span>'
                 : '<span class="badge ok">No frost</span>') +
        '</td>';
      tb.appendChild(tr);
    });
    if (!rows.length) tb.innerHTML = '<tr><td colspan="4">No predictions for this range.</td></tr>';
  }catch(e){
    setSignedInUI(true);
    msg.textContent = 'JS error: ' + (e && e.message ? e.message : e);
    console.error(e);
  }
}

/* ---------- Wire up ---------- */
$('auth').addEventListener('submit', (e)=>{
  e.preventDefault();
  try{
    const user = $('u').value.trim(), pass = $('p').value;
    if (!user || !pass) { $('msg').textContent = 'Enter username and password.'; return; }
    AUTH = 'Basic ' + b64utf8(user + ':' + pass);
  }catch(err){
    $('msg').textContent = 'Could not encode credentials.'; $('debug').textContent = (err && err.message) ? err.message : String(err); return;
  }
  $('msg').textContent = 'Signed in.';
  setSignedInUI(true);
  loadPredictions();
});

$('signout').addEventListener('click', ()=>{
  AUTH = null; $('msg').textContent = 'Signed out.'; setSignedInUI(false);
  qs('#t tbody').innerHTML = '<tr><td colspan="4">Please sign in…</td></tr>';
});

$('filters').addEventListener('submit', (e)=>{
  e.preventDefault();
  loadPredictions();
});

// defaults: last 24h
setPreset('24h');
</script>
</body>
</html>
